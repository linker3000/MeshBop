[{"id":"93d6d842b8196198","type":"tab","label":"Setup / Node in / Node out","disabled":false,"info":"","env":[]},{"id":"7e38f245f39c82ac","type":"tab","label":"Help / Ping / Test","disabled":false,"info":"","env":[]},{"id":"f249cd112cbafc4c","type":"tab","label":"Weather / Time / Astro","disabled":false,"info":"","env":[]},{"id":"d3adc843bdd47b30","type":"tab","label":"Severe weather","disabled":false,"info":"","env":[]},{"id":"2f92a99e559c4ceb","type":"tab","label":"News","disabled":false,"info":"","env":[]},{"id":"85744c86c3981ac5","type":"tab","label":"Zen / Info msg","disabled":false,"info":"","env":[]},{"id":"03120120b21c40b4","type":"tab","label":"Dashboard","disabled":false,"info":"","env":[]},{"id":"c8c215c3701e6bd4","type":"junction","z":"2f92a99e559c4ceb","x":240,"y":140,"wires":[["bbdab6b4bfda1db3","b35ec2380126e7c5","76bd19d8ca5dd88a"]]},{"id":"62ca58f23eafdae1","type":"junction","z":"93d6d842b8196198","x":680,"y":160,"wires":[["ee70b33014c74181","e68504e5eefbb185"]]},{"id":"bea9514f28a49a31","type":"serial-port","name":"","serialport":"/dev/ttyAMA0","serialbaud":"19200","databits":8,"parity":"none","stopbits":1,"waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\n","bin":"false","out":"char","addchar":"","responsetimeout":10000},{"id":"75e472929b1b6af3","type":"ui-base","name":"My Dashboard","path":"/dashboard","appIcon":"","includeClientData":true,"acceptsClientConfig":["ui-notification","ui-control"],"showPathInSidebar":false,"headerContent":"page","navigationStyle":"default","titleBarStyle":"default","showReconnectNotification":true,"notificationDisplayTime":1,"showDisconnectNotification":true,"allowInstall":false},{"id":"2a9ed847435a3de8","type":"ui-theme","name":"Default Theme","colors":{"surface":"#ffffff","primary":"#0094CE","bgPage":"#eeeeee","groupBg":"#ffffff","groupOutline":"#cccccc"},"sizes":{"density":"default","pagePadding":"12px","groupGap":"12px","groupBorderRadius":"4px","widgetGap":"12px"}},{"id":"277e2b0f220aaa63","type":"ui-page","name":"REDTastic Dashboard","ui":"75e472929b1b6af3","path":"/page1","icon":"home","layout":"grid","theme":"2a9ed847435a3de8","breakpoints":[{"name":"Default","px":"0","cols":"3"},{"name":"Tablet","px":"576","cols":"6"},{"name":"Small Desktop","px":"768","cols":"9"},{"name":"Desktop","px":"1024","cols":"12"}],"order":1,"className":"","visible":"true","disabled":"false"},{"id":"50c1d0e584ea6dda","type":"ui-group","name":"REDTastic dashboard","page":"277e2b0f220aaa63","width":6,"height":1,"order":1,"showTitle":false,"className":"","visible":"true","disabled":"false","groupType":"default"},{"id":"f647bdc9b47b1dc2","type":"function","z":"93d6d842b8196198","name":"** Read me, and set global variables in here before you start **","func":"/**\n * Project: REDTastic V0.00 beta \n * Author:  Linker3000 (linker3000@gmail-dot-thingy)\n * License: Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International \n * (CC BY-NC-SA 4.0)\n *\n * You are free to:\n * - Share — copy and redistribute the material in any medium or format\n * - Adapt — remix, transform, and build upon the material\n *\n * Under the following terms:\n * - Attribution — You must give appropriate credit.\n * - NonCommercial — You may not use the material for commercial purposes.\n * - ShareAlike — If you remix, transform, or build upon the material, you \n *     must distribute your contributions under the same license.\n *\n * Full License Text: https://creativecommons.org/licenses/by-nc-sa/4.0/\n \nA simple messaging system for Meshtastic that uses the TEXTMSG serial\nfunction to send selected messages triggered by the received messages. \nThere is also a dashboard page for sending and receiving messages.\n\nAll messages are received and sent to the first (primary) Meshtastic channel, \nso if you want to use this application in a private group, that group MUST be \nthe FIRST channel on the meshtastic node handling messaging. See publisjhed \ndocs for more info.\n\nYou'll find more setup details at: https://github.com/linker3000/REDTastic\n\nFeel free to suggest improvements or changes. It will be especially helpful\nto receive flows to use this app with other news and weather services.\n\nNotes:\n\nRead all these notes carefully. before changing anything.\n\nThe accuracy and results of these flows depends on your setup work and third party code.\nThis app is supplied 'as is'. Use at your own risk. No responsibility is accepted for \nconsequential loss or errors. Feedback is welcome at the address above or the Issues\ntab at the GitHub project page.\n\nAs of September 2025, there is a bug in the Meshtastic node firmware, and TEXTMSG\nmode (used by this code) may transmit a spurious character when the node is powered\non or off. This has been reported and is nothing to do with this app.\n\n*** Some features in this app are disabled by default. See the notes below. ***\n\n*** Some pages have further notes and comments in the top left corner of their tab  ***\n\n************************************************************************************\nWhen testing, disable the Async out node on this tab and save\nyour change so that you don't send out test messages. You can see what's being\ngenerated in the debug window on that tab.\nDo pre-live testing in a secondary (private) channel.\nRemember to re-enable the node when you're ready to rock.\n\nThe Async out node may already be disabled when you install these flows - do check.\n\nSome flows have rate limiting nodes, please respect the mesh and don't do \nanything that might flood it with messages. If in doubt, disable the \nAsync out node on this tab and reload Node-RED before testing.\n\nSome flows have inject inputs for testing. If any of the functionality (such\nas message triggering) is changed, these may need to be changed too.\n************************************************************************************\n---------------------------------------------------------------------------------\n\nSet global variables below. Some variables may be 'for future use'.\n\n>> If you want emails sent (eg: Severe weather warnings):\n\n* Configure your email details address below.\n* Configure, enable (if disabled) and test the Email node on this tab.\n* By default, the severe weather warnings are only sent to email. Modify the \n*   link-outs on that page when you are good to send to the Mesh too.\n\n>> Things you must do here and on other tabs:\n\n* Set the async port parameters for the input and output nodes. These must match those\n  set on your Meshtastic node in its radio configuration.\n\nIf running on a Linux system, and your async in and out nodes don't work \nor don't show as 'connected', you may need to add the account running Node-RED\nto the 'dialout' group or equivalent for your distribution. This is well-documented -\ntry a Web search for 'linux dialout serial'.\n\n* The weather info comes from Open-Meteo and should work if the Lat and Long\n  are set below to the right location, otherwise the fallback is central London.\n\n* Set up and enable the Severe Weather flow (Optional - see its tab for more notes)\n    By default, the severe weather warnings are picked up from the UK Met Office and\n    Open-Meteo (thunderstorms and high winds). You might wish to change this.\n\n* Check or set your message trigger texts in the \"Parse Rx message\" function\n    on this tab.\n\n* Modify your Help messages to match your trigger texts.\n\n*/\n\n// SET THESE...\n\n// The trigger pattern for your messages - recommended to be a slash followed\n// by your pattern, for example, mine is /l3k, so to trigger the news\n//response, someone sends /l3kn etc..\nglobal.set('basePattern', '/l3k');\n\n// The pattern that is used to send a help/info message\n// set to '' if you don't have one. This should match how the function \n// block on this tab is set to trigger for this message.  \nglobal.set('helpMsg','/l3k?');\n\n// Fixed IP address of this server (not actually used yet if this message is here)\nglobal.set ('myIP','0.0.0.0');\n\n// Set your location (static text) - used in some messages. \nglobal.set('location', 'Town, County');\n\n// Set your Region - a more generalised location.\nglobal.set('region', 'County or region');\n\n//Set this for Astro and weather. The default here is central London...\nglobal.set('latitude', 51.50742);   \nglobal.set('longitude', 0.1278);  \nglobal.set('height', 10.0);  // Elevation above MSL in meters\n\n//For timezone:\nglobal.set('locale','en-GB');\n\n//Set your email addresses for weather alerts (if email is enabled):\nglobal.set('emailTo', 'myaddress@example.com')\nglobal.set('emailFrom', 'fromaddress@example.com')\n\n// Also set your email account details (user name and password etc.)\n// in the email node on this tab, and the email node may \n// need to be enabled.\n\n// Don't change these please!\nglobal.set('version','REDTastic V0.0beta.');\nglobal.set('info','REDTastic is a Meshtastic messaging system written in Node-RED by Linker3000. See https://github.com/linker3000/REDTastic');\n\nreturn null;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":60,"wires":[[]]},{"id":"c22f5e54f169b1c8","type":"inject","z":"93d6d842b8196198","name":"Initialise","props":[{"p":"payload"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":200,"y":60,"wires":[["f647bdc9b47b1dc2"]]},{"id":"589426dd2a727882","type":"serial in","z":"93d6d842b8196198","name":"Async in","serial":"bea9514f28a49a31","x":140,"y":540,"wires":[["5e58f170b1ed64c4"]]},{"id":"5e58f170b1ed64c4","type":"function","z":"93d6d842b8196198","name":"Sanitise string","func":"let str = msg.payload;\n\n// Remove any leading or trailing spaces in the received message.\nstr = str.trim();\n\n// Remove any non-ASCII characters in the middle of the string\nstr = str.replace(/[^\\x20-\\x7E]/g, '');  // Keeps printable ASCII characters (0x20 to 0x7E)\n\nif (str == '') return null;\n\nmsg.payload = str;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":540,"wires":[["d49c5b7a06e746e6","08177ad9b6ad71ed","18bd360c5face0f7"]]},{"id":"2c8cd91f56571166","type":"link out","z":"93d6d842b8196198","name":"Weather trigger","mode":"link","links":["faa0c7458cf1ed93"],"x":705,"y":680,"wires":[]},{"id":"6bd591770bed46f9","type":"link out","z":"93d6d842b8196198","name":"Help trigger","mode":"link","links":["cf009b7977aef1b8"],"x":705,"y":760,"wires":[]},{"id":"dd857ed9a24a14d1","type":"link out","z":"93d6d842b8196198","name":"News trigger","mode":"link","links":["d5bba44b625f68fc"],"x":705,"y":720,"wires":[]},{"id":"a12840e822be1534","type":"link out","z":"93d6d842b8196198","name":"Astro trigger","mode":"link","links":["02fb3b3c8362f808"],"x":705,"y":800,"wires":[]},{"id":"648b121e3ad619e4","type":"link out","z":"93d6d842b8196198","name":"MOTD trigger","mode":"link","links":["dec68dbab3675569"],"x":705,"y":840,"wires":[]},{"id":"ee70b33014c74181","type":"serial out","z":"93d6d842b8196198","d":true,"name":"Async out","serial":"bea9514f28a49a31","x":800,"y":140,"wires":[]},{"id":"0bb32ddf524a90dc","type":"link in","z":"93d6d842b8196198","name":"Node Tx","links":["b0299e20d55bcae2","f5cc8e6570db4294","4a9a804345cca0fb","94ed5dec96f4d051","61011ccbb0a21b8d","b30d87047c75a012","120e3856efb68a6c","52718e6c26c351ae","7dc3f411794e0b2c","b0cf85ea70025816"],"x":135,"y":160,"wires":[["bc3eb8b032ede120"]]},{"id":"e68504e5eefbb185","type":"function","z":"93d6d842b8196198","name":"Debug output","func":"let payloadLength = (typeof msg.payload === 'string') ? msg.payload.length : 0;\n\nmsg.payload = msg.payload + \" (\" + payloadLength + \")\";\nnode.warn (msg.payload)\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":200,"wires":[[]]},{"id":"74c5c95988cf5ac9","type":"delay","z":"93d6d842b8196198","name":"Rate limit","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":580,"y":160,"wires":[["62ca58f23eafdae1"]]},{"id":"68b3a0cb5b77c42a","type":"link out","z":"93d6d842b8196198","name":"Test / Ping trigger","mode":"link","links":["7780159160157683"],"x":705,"y":880,"wires":[]},{"id":"d49c5b7a06e746e6","type":"debug","z":"93d6d842b8196198","name":"Received","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":540,"y":580,"wires":[]},{"id":"08177ad9b6ad71ed","type":"link out","z":"93d6d842b8196198","name":"Received message","mode":"link","links":["f30b4a22c3ca92d3"],"x":615,"y":540,"wires":[]},{"id":"994ca355f0e157f7","type":"e-mail","z":"93d6d842b8196198","d":true,"server":"172.16.2.1","port":"465","authtype":"BASIC","saslformat":true,"token":"oauth2Response.access_token","secure":false,"tls":false,"name":"","dname":"Email","x":610,"y":380,"wires":[]},{"id":"18c893f109f93670","type":"link in","z":"93d6d842b8196198","name":"Send an email","links":["52718e6c26c351ae","120e3856efb68a6c"],"x":135,"y":380,"wires":[["72a789b68af22068"]]},{"id":"29a9c18e82eb5abc","type":"inject","z":"93d6d842b8196198","name":"Test email","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"REDTastic. Test email","payload":"Hello. This is a test email from REDTastic","payloadType":"str","x":200,"y":440,"wires":[["72a789b68af22068"]]},{"id":"72a789b68af22068","type":"change","z":"93d6d842b8196198","name":"Configure email","rules":[{"t":"set","p":"to","pt":"msg","to":"emailTo","tot":"global"},{"t":"set","p":"from","pt":"msg","to":"emailFrom","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":380,"wires":[["994ca355f0e157f7","f1a9ff44a33e3eaf"]]},{"id":"f1a9ff44a33e3eaf","type":"debug","z":"93d6d842b8196198","name":"Debug email","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":420,"wires":[]},{"id":"18bd360c5face0f7","type":"function","z":"93d6d842b8196198","name":"Parse Rx message","func":"// Parses the received message and decides what to do with it.\n// This is all done with Regex (sorry!), but is not too hard\n// to work out and test if you check out the default conditions below.\n// You can keep these defaults, change them or add your own.\n//\n// ** If you add a new test, remember to go to the setup tab here and\n// add another output for it.\n//\n// Always test with the Tx node disabled + in a private channel \n// before you 'go live'. \n\n// Check for null message first - if so, do nothing.\nif (!msg || msg.payload === null || msg.payload === undefined) {\n    return null;\n}\n\n// Get the trigger prefix being looked for. Just in case it's unset\n// in the global parameters you can put a fallback here.\n// Once defined, the message triggers all start with the prefix\n// string so, for example, we can have a trigger on /l3kz to get \n// a random inspirational (or otherwise!) Zen message.\n//\n// To help with debugging, info about the chosen output is \n// sent to output 1, which has a debug node connected to it. \n\n// Changing the l3k here will change the default message trigger check.\n// It can be left 'as is' if the basePattern global variable is set\n// properly in the setup function block on the first tab because\n// that will override the l3k here.\nlet basePattern = global.get(\"basePattern\") || \"/l3k\";\nnode.warn(basePattern);\n\n// Convert payload to string and strip sender ID\nlet content = String(msg.payload || \"\").replace(/^[^:]+:\\s*/, \"\");\n\n// Define the regex patterns with dynamic base and descriptions\nconst patterns = [\n    {regex: new RegExp(basePattern + \"w$\"), desc: \"w pattern\"},                    // Output 2\n    {regex: new RegExp(basePattern + \"n(,\\\\d+(,u)?)?$\"), desc: \"n pattern\"},       // Output 3  \n    {regex: new RegExp(basePattern + \"\\\\?$\"), desc: \"? pattern\"},                  // Output 4\n    {regex: new RegExp(basePattern + \"t$\"), desc: \"t pattern\"},                    // Output 5\n    {regex: new RegExp(basePattern + \"z$\"), desc: \"z pattern\"},                    // Output 6\n    {regex: new RegExp(\"(test|testing)$\"), desc: \"test pattern\"},                  // Output 7\n    {regex: new RegExp(\"ping$\"), desc: \"ping pattern\"},                            // Output 8\n    {regex: new RegExp(basePattern + \"i$\"), desc: \"i pattern\"},                    // Output 9\n\n];\n\n// Test each pattern against the stripped message\nfor (let i = 0; i < patterns.length; i++) {\n    if (patterns[i].regex.test(content)) {\n        // Create debug message for first output\n        let debugMsg = {\n            payload: `Output ${i + 2} selected: \"${content}\" matched ${patterns[i].desc} (${patterns[i].regex.source})`\n        };\n        \n        // Create array of 8 null outputs (1 debug + 7 original)\n        let outputs = new Array(8).fill(null);\n        outputs[0] = debugMsg;           // Debug output\n        outputs[i + 1] = msg;           // Original message to matching output\n        return outputs;\n    }\n}\n\n// No match found - send debug message\nlet noMatchMsg = {payload: `No match found for: \"${content}\"`};\nlet outputs = new Array(8).fill(null);\noutputs[0] = noMatchMsg;\nreturn outputs;","outputs":9,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":680,"wires":[["4568461fa4318ba3"],["2c8cd91f56571166"],["dd857ed9a24a14d1"],["6bd591770bed46f9"],["a12840e822be1534"],["648b121e3ad619e4"],["68b3a0cb5b77c42a"],["68b3a0cb5b77c42a"],["2209f52df597f83d"]]},{"id":"07f352ab822bbad5","type":"inject","z":"93d6d842b8196198","name":"Test news (no params)","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3kn","payloadType":"str","x":200,"y":600,"wires":[["18bd360c5face0f7"]]},{"id":"4568461fa4318ba3","type":"debug","z":"93d6d842b8196198","name":"Debug for message triggers","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":740,"y":640,"wires":[]},{"id":"257579419b4e35c7","type":"inject","z":"93d6d842b8196198","name":"Test news ,2,u","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3kn,2,u","payloadType":"str","x":170,"y":640,"wires":[["18bd360c5face0f7"]]},{"id":"871b61640761bf7f","type":"inject","z":"93d6d842b8196198","name":"Test weather","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3kw","payloadType":"str","x":170,"y":680,"wires":[["18bd360c5face0f7"]]},{"id":"5066383d9ac4b7e4","type":"inject","z":"93d6d842b8196198","name":"Test motd","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3km","payloadType":"str","x":160,"y":760,"wires":[["18bd360c5face0f7"]]},{"id":"bc7f62f929043676","type":"inject","z":"93d6d842b8196198","name":"Test help","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3k?","payloadType":"str","x":160,"y":800,"wires":[["18bd360c5face0f7"]]},{"id":"76316dc719d94acc","type":"inject","z":"93d6d842b8196198","name":"Test time/astro","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3kt","payloadType":"str","x":180,"y":720,"wires":[[]]},{"id":"37cb47dd8d5cc77a","type":"function","z":"93d6d842b8196198","name":"Ident message","func":"if (global.get('version') && global.get('helpMsg')) {\n    msg.payload = global.get('version') + ' Send \"' + global.get('helpMsg') + '\" for menu.';\n    return msg;\n} else {\n    return null; // Don't send anything if either value is missing or empty\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":240,"wires":[["74c5c95988cf5ac9"]]},{"id":"b24343ba7d6ac956","type":"link in","z":"93d6d842b8196198","name":"Send ident message","links":["61011ccbb0a21b8d","b0299e20d55bcae2","52718e6c26c351ae","120e3856efb68a6c","4a9a804345cca0fb","94ed5dec96f4d051","f5cc8e6570db4294","7dc3f411794e0b2c"],"x":135,"y":220,"wires":[["ea58d70f82022a7e"]]},{"id":"56a82ba3f2bf82f4","type":"inject","z":"93d6d842b8196198","name":"Send ident message","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"86400","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":240,"y":280,"wires":[["37cb47dd8d5cc77a"]]},{"id":"ea58d70f82022a7e","type":"delay","z":"93d6d842b8196198","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":220,"wires":[["37cb47dd8d5cc77a"]]},{"id":"8dbeca93f6b12013","type":"inject","z":"93d6d842b8196198","name":"Reset all rate limits","props":[{"p":"reset","v":"true","vt":"bool"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":230,"y":100,"wires":[["74c5c95988cf5ac9","b9f3d38e3d1fc041"]]},{"id":"b9f3d38e3d1fc041","type":"link out","z":"93d6d842b8196198","name":"Reset rate limits","mode":"link","links":["4e949e63fb52546c","f09a1a190d73baaf","eca053148a224921","82fa93b2c0d63529"],"x":435,"y":100,"wires":[]},{"id":"2209f52df597f83d","type":"link out","z":"93d6d842b8196198","name":"Info message trigger","mode":"link","links":["b561b5dcbaec1970"],"x":705,"y":920,"wires":[]},{"id":"97e164f2f99ea1c1","type":"inject","z":"93d6d842b8196198","name":"Test info","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /l3ki","payloadType":"str","x":160,"y":840,"wires":[["18bd360c5face0f7"]]},{"id":"bc3eb8b032ede120","type":"function","z":"93d6d842b8196198","name":"Process multiple message","func":"let message = msg.payload;\n\n// Split the message at each newline (\\r) character\nlet sections = message.split('\\r');\n\n// Regular expression to match and remove non-ASCII characters\nlet asciiOnlyRegex = /[^\\x20-\\x7E]/g;\n\n// Max length for each segment\nconst MAX_LENGTH = 198;\n\nfunction sendSection(i) {\n    if (i < sections.length) {\n        // Clean the section: remove non-ASCII characters\n        let cleanedSection = sections[i].replace(asciiOnlyRegex, '');\n\n        // Skip sending empty sections\n        if (cleanedSection === '') {\n            sendSection(i + 1);\n            return;\n        }\n\n        // Break the cleaned section into chunks of MAX_LENGTH\n        for (let start = 0; start < cleanedSection.length; start += MAX_LENGTH) {\n            let chunk = cleanedSection.substring(start, start + MAX_LENGTH);\n\n            // Add a newline (\\r) only if this is the final chunk\n            // of this section *and* it is not the last overall section\n            if (start + MAX_LENGTH >= cleanedSection.length && i < sections.length - 1) {\n                chunk += '\\r';\n            }\n\n            let newMsg = { ...msg };\n            newMsg.payload = chunk;\n            node.send(newMsg);\n        }\n\n        // Process the next section\n        sendSection(i + 1);\n    }\n}\n\n// Start processing\nsendSection(0);\n\n// Prevent the original message from being sent\nreturn null;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":160,"wires":[["74c5c95988cf5ac9"]]},{"id":"cf009b7977aef1b8","type":"link in","z":"7e38f245f39c82ac","name":"Help in","links":["6bd591770bed46f9"],"x":175,"y":80,"wires":[["9c1021087798cee9"]]},{"id":"f5cc8e6570db4294","type":"link out","z":"7e38f245f39c82ac","name":"Help out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":735,"y":80,"wires":[]},{"id":"9c1021087798cee9","type":"function","z":"7e38f245f39c82ac","name":"Help text","func":"msg.payload = \n'Use /l3k_ for all commands (eg: /l3km), except as noted.\\r' +\n'w=weather (eg: /l3kw), t=time and astro info, z=zen quote,\\r' +\n'n=BBC news. Add ,num for # articles (max 10). Add ,u for urls eg: /l3kn,5,u.\\r' +\n\"'ping' or 'test' as a full message (no prefix) return an ack.\\r\" +\n'Send i for more info. Some actions are globally rate limited.\\r' \n;\n \nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":80,"wires":[["bdf8616c1fb23472"]]},{"id":"87a193deb781b17d","type":"inject","z":"7e38f245f39c82ac","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":230,"y":140,"wires":[["9c1021087798cee9"]]},{"id":"bdf8616c1fb23472","type":"delay","z":"7e38f245f39c82ac","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":580,"y":80,"wires":[["f5cc8e6570db4294","315225e39cbec88a"]]},{"id":"315225e39cbec88a","type":"debug","z":"7e38f245f39c82ac","name":"Help Text","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":660,"y":160,"wires":[]},{"id":"7780159160157683","type":"link in","z":"7e38f245f39c82ac","name":"Test / Ping in","links":["68b3a0cb5b77c42a"],"x":175,"y":260,"wires":[["b77a2694d0ec1572"]]},{"id":"b77a2694d0ec1572","type":"function","z":"7e38f245f39c82ac","name":"Ping / Test reply","func":"let parts = msg.payload.split(\":\");\nlet location = global.get('location');\nlet currentTime = new Date().toLocaleTimeString(global.get('locale') || 'en-GB', { hour12: false });\n\nmsg.payload = `Hello ${parts[0].trim()}. ${parts[1].trim().charAt(0).toUpperCase() \n  + parts[1].trim().slice(1).toLowerCase()\n    } received in ${location} at ${currentTime}` + ' (local).';\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":260,"wires":[["197d2fb5dd6918cf"]]},{"id":"61011ccbb0a21b8d","type":"link out","z":"7e38f245f39c82ac","name":"Ping / test out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":735,"y":260,"wires":[]},{"id":"197d2fb5dd6918cf","type":"delay","z":"7e38f245f39c82ac","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"6","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":590,"y":260,"wires":[["61011ccbb0a21b8d","da899a743dbba613"]]},{"id":"28d24d18a20a526a","type":"comment","z":"7e38f245f39c82ac","name":"","info":"The regex in the function node on the first tab \nallows the ping test text to be returned for\nthe following:\n\nping, /ping, test or /test\n\n...only if there is nothing else in the message.\n","x":120,"y":20,"wires":[]},{"id":"ea62148bef53b371","type":"inject","z":"7e38f245f39c82ac","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"AAAA: /test?","payloadType":"str","x":230,"y":320,"wires":[["b77a2694d0ec1572"]]},{"id":"da899a743dbba613","type":"debug","z":"7e38f245f39c82ac","name":"Ping debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":650,"y":320,"wires":[]},{"id":"4e949e63fb52546c","type":"link in","z":"7e38f245f39c82ac","name":"Reset rate limits","links":["b9f3d38e3d1fc041"],"x":425,"y":180,"wires":[["bdf8616c1fb23472","197d2fb5dd6918cf"]]},{"id":"faa0c7458cf1ed93","type":"link in","z":"f249cd112cbafc4c","name":"Weather in","links":["2c8cd91f56571166"],"x":95,"y":80,"wires":[["0e95df194fd774d8"]]},{"id":"2471f1baac391366","type":"debug","z":"f249cd112cbafc4c","name":"Wind Dir","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":880,"y":60,"wires":[]},{"id":"6230f19bf5072b0e","type":"debug","z":"f249cd112cbafc4c","name":"Feels Like","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":890,"y":260,"wires":[]},{"id":"02d84561c2fd499e","type":"debug","z":"f249cd112cbafc4c","name":"Wind Speed","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":890,"y":100,"wires":[]},{"id":"1bbcde448543aea1","type":"debug","z":"f249cd112cbafc4c","name":"Pressure","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":880,"y":180,"wires":[]},{"id":"46612cc796ccbeb8","type":"debug","z":"f249cd112cbafc4c","name":"Summary","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":880,"y":140,"wires":[]},{"id":"a1ae087361879eda","type":"debug","z":"f249cd112cbafc4c","name":"Temp","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":870,"y":220,"wires":[]},{"id":"677acb88af5034ef","type":"debug","z":"f249cd112cbafc4c","name":"Full String","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":880,"y":380,"wires":[]},{"id":"b0299e20d55bcae2","type":"link out","z":"f249cd112cbafc4c","name":"Weather out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":855,"y":440,"wires":[]},{"id":"0e95df194fd774d8","type":"trigger","z":"f249cd112cbafc4c","name":"Trigger","op1":"true","op2":"","op1type":"bool","op2type":"nul","duration":"250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":200,"y":80,"wires":[["df8f85e9d64ef11d"]]},{"id":"71116f78efd99135","type":"astrodata dayvalues","z":"f249cd112cbafc4c","name":"","lon":"","lat":"","height":"","lang":"en","offset":0,"x":460,"y":480,"wires":[["d97fa21cb4276230"]]},{"id":"02fb3b3c8362f808","type":"link in","z":"f249cd112cbafc4c","name":"Astro in","links":["a12840e822be1534"],"x":135,"y":480,"wires":[["2a0860dd2b8e63aa"]]},{"id":"95b8d73d645b87f8","type":"debug","z":"f249cd112cbafc4c","name":"Time","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":870,"y":480,"wires":[]},{"id":"692dbb9f79178bf2","type":"inject","z":"f249cd112cbafc4c","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":190,"y":420,"wires":[["2a0860dd2b8e63aa"]]},{"id":"d97fa21cb4276230","type":"function","z":"f249cd112cbafc4c","name":"Astro message","func":"// Ensure the data is available in msg (sunRise and sunSet)\nlet sunrise = msg.sunRise;   \nlet sunset = msg.sunSet; \n\n// Get the current local time in 24-hour format. Falls back to en-GB if the locale is not set\nlet currentTime = new Date().toLocaleTimeString(global.get('locale') || 'en-GB', { hour12: false });\n\n// Get the current UTC time in 24-hour format\nlet utcTime = new Date().toUTCString().split(' ')[4];  // Get the time part from UTC string\n\nmsg.payload = global.get('location') + \n\": Local time: \" + currentTime + \n\". UTC time: \"   + utcTime + \n\". Sunrise: \"    + sunrise + \n\". Sunset: \"     + sunset + \".\";\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":480,"wires":[["95b8d73d645b87f8","b0299e20d55bcae2"]]},{"id":"2a0860dd2b8e63aa","type":"function","z":"f249cd112cbafc4c","name":"Get params","func":"// Retrieve global variables to be used in the call to astrodata\nmsg.lat    = global.get('latitude');\nmsg.lon    = global.get('longitude');\nmsg.height = global.get('height');\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":480,"wires":[["71116f78efd99135"]]},{"id":"ab426fd0175bfe2b","type":"inject","z":"f249cd112cbafc4c","name":"Test","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":150,"y":140,"wires":[["df8f85e9d64ef11d"]]},{"id":"df8f85e9d64ef11d","type":"function","z":"f249cd112cbafc4c","name":"Open Meteo","func":"// Get coordinates from global context, fallback to centre of London\nlet lat = global.get('latitude') || 51.5074;\nlet lon = global.get('longitude') || -0.1278;\n\n// Set the URL with additional parameters\nmsg.url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl&timezone=Europe/London`;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":80,"wires":[["4fcd60063f07e5a2"]]},{"id":"4fcd60063f07e5a2","type":"http request","z":"f249cd112cbafc4c","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":390,"y":140,"wires":[["2ab9d9ff54cdf0dc"]]},{"id":"2ab9d9ff54cdf0dc","type":"function","z":"f249cd112cbafc4c","name":"Weather Info Open-Meteo","func":"// Debug: Check what we're receiving\nnode.warn(\"Full message: \" + JSON.stringify(msg));\nnode.warn(\"Payload type: \" + typeof msg.payload);\nnode.warn(\"Payload: \" + JSON.stringify(msg.payload));\n\n// Handle different response formats\nvar weatherData;\nif (typeof msg.payload === \"string\") {\n    // If it's a string, parse it as JSON\n    try {\n        weatherData = JSON.parse(msg.payload);\n    } catch (e) {\n        node.error(\"Failed to parse JSON: \" + e.message);\n        return null;\n    }\n} else if (typeof msg.payload === \"object\") {\n    // If it's already an object, use it directly\n    weatherData = msg.payload;\n} else {\n    node.error(\"Unexpected payload type: \" + typeof msg.payload);\n    return null;\n}\n\n// Check if we have the expected structure\nif (!weatherData || !weatherData.current) {\n    node.error(\"Invalid payload structure. Expected current weather data\");\n    node.error(\"Available keys: \" + Object.keys(weatherData || {}));\n    return null;\n}\n\nvar airPressure = weatherData.current.pressure_msl;\nvar windAngle = weatherData.current.wind_direction_10m;\nvar windCompass = {};\nvar windSpeed = {};\nvar weatherDescription = {};\nvar airTemperature = {};\nvar feelsLikeTemp = {};\nvar fullWeatherString = {};\nvar msgPressure = {};\nvar weatherCodeOutput = {};\n\nvar compassDirections = [\"North\", \"North-East\", \"East\", \"South-East\", \"South\", \"South-West\", \"West\", \"North-West\"];\n\nvar weatherDescriptions = {\n    0: \"Clear sky\",\n    1: \"Mainly clear\",\n    2: \"Partly cloudy\",\n    3: \"Overcast\",\n    45: \"Fog\",\n    48: \"Depositing rime fog\",\n    51: \"Light drizzle\",\n    53: \"Moderate drizzle\",\n    55: \"Dense drizzle\",\n    61: \"Slight rain\",\n    63: \"Moderate rain\",\n    65: \"Heavy rain\",\n    71: \"Slight snow\",\n    73: \"Moderate snow\",\n    75: \"Heavy snow\",\n    95: \"Thunderstorm\"\n};\n\n// Calculate direction and store in object\nvar windDirectionText = compassDirections[Math.round(((windAngle %= 360) < 0 ? windAngle + 360 : windAngle) / 45) % 8];\nwindCompass = { payload: windDirectionText };\n\n// Wind speed in mph, rounded to nearest 0.5\nwindSpeed = {\n    payload: Math.round(weatherData.current.wind_speed_10m * 0.621371 * 2) / 2\n};\n\nmsgPressure.payload = airPressure;\nairTemperature.payload = weatherData.current.temperature_2m.toFixed(1) + \"C\";\n\n// Handle apparent temperature\nfeelsLikeTemp.payload = weatherData.current.apparent_temperature ?\n    weatherData.current.apparent_temperature.toFixed(1) + \"C\" :\n    airTemperature.payload;\n\n// Get weather description from code\nvar weatherCode = weatherData.current.weather_code;\nweatherDescription.payload = weatherDescriptions[weatherCode] || (\"Weather code \" + weatherCode);\n\n// Weather code as separate output\nweatherCodeOutput.payload = weatherCode;\n\n// Assemble final string\nvar locationName = global.get(\"location\") || \"Location\";\nfullWeatherString.payload = locationName + \": \" +\n    weatherDescription.payload +\n    \". Temp: \" + airTemperature.payload +\n    \". Feels like: \" + feelsLikeTemp.payload +\n    \". Wind: \" + windSpeed.payload + \"mph \" + windCompass.payload +\n    \". Pressure: \" + msgPressure.payload + \"mb\";\n\nreturn [windCompass, windSpeed, weatherDescription, msgPressure, airTemperature, feelsLikeTemp, weatherCodeOutput,fullWeatherString];","outputs":8,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":140,"wires":[["2471f1baac391366"],["02d84561c2fd499e"],["46612cc796ccbeb8"],["1bbcde448543aea1"],["a1ae087361879eda"],["6230f19bf5072b0e"],["4f897640bbd7954f","2cf387f46b609b96"],["677acb88af5034ef","b0299e20d55bcae2"]]},{"id":"4f897640bbd7954f","type":"debug","z":"f249cd112cbafc4c","name":"Weather Code","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":900,"y":340,"wires":[]},{"id":"2cf387f46b609b96","type":"link out","z":"f249cd112cbafc4c","name":"Weather code","mode":"link","links":[],"x":855,"y":300,"wires":[]},{"id":"80d3bd42f4b8420c","type":"inject","z":"d3adc843bdd47b30","name":"Check for warning","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1800","crontab":"","once":false,"onceDelay":"2","topic":"","payload":"true","payloadType":"bool","x":170,"y":100,"wires":[["678370c286858209","bf5e7bd00d181d3a"]]},{"id":"caebc459f9ed3b37","type":"function","z":"d3adc843bdd47b30","name":"Generate a warning","func":"const feed = msg.payload;\n\n// Check for a valid RSS structure with at least one item\nif (\n    !feed.rss ||\n    !Array.isArray(feed.rss.channel) ||\n    feed.rss.channel.length === 0 ||\n    !Array.isArray(feed.rss.channel[0].item) ||\n    feed.rss.channel[0].item.length === 0\n) {\n    return null; // No warnings — return no output\n}\n\n// Extract the first warning item\nconst firstItem = feed.rss.channel[0].item[0];\n\n// Extract and trim the description\nlet description = firstItem.description?.[0]?.trim() || \"\";\ndescription = description.substring(0, 198);\n\n// Extract the URL from the guid field\nconst url = firstItem.guid?.[0]?._ || \"\";\n\n// Assign to message fields\nmsg.payload = description;\nmsg.message = description;\nmsg.url = url;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":160,"wires":[["2daf835f737d752d"]]},{"id":"0a6b6c133416ad39","type":"inject","z":"d3adc843bdd47b30","name":"Test short  msg","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"rss\":{\"channel\":[{\"item\":[{\"title\":[\"TEST MESSAGE Yellow warning of thunderstorm\"],\"description\":[\"TEST MESSAGE Yellow warning of thunderstorms affecting London & South East England: valid from 1000 Wed 03 Sep to 1900 Wed 03 Sep.\"],\"guid\":[{\"_\":\"https://example.com/yellow-thunderstorm\"}]}]}]}}","payloadType":"json","x":160,"y":200,"wires":[["caebc459f9ed3b37"]]},{"id":"6ffbc95fd64a73d8","type":"xml","z":"d3adc843bdd47b30","name":"","property":"payload","attr":"","chr":"","x":650,"y":100,"wires":[["caebc459f9ed3b37"]]},{"id":"63e7ac5734a0fd01","type":"debug","z":"d3adc843bdd47b30","name":"Debug Met Office","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":670,"y":280,"wires":[]},{"id":"2daf835f737d752d","type":"function","z":"d3adc843bdd47b30","name":"Get Tinyurl","func":"// Get the long URL from msg.payload\nlet longUrl = msg.url;\n\n// Check if the long URL is valid\nif (!longUrl || typeof longUrl !== 'string') {\n    node.error(\"Invalid URL\", msg);\n    return null;  // Exit the function if the URL is invalid\n}\n\n// Check if the URL contains a '?'\nlet questionMarkIndex = longUrl.indexOf('?');\n\n// If it contains a '?', remove everything after it, including the '?' itself\nif (questionMarkIndex !== -1) {\n    longUrl = longUrl.substring(0, questionMarkIndex);  // Keep the part before '?'\n}\n\n// Prepare the URL for TinyURL\nlet tinyUrlApi = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`;\n\n// Set the HTTP request configuration\nmsg.url = tinyUrlApi;  // TinyURL API endpoint\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":160,"wires":[["a674c122c98dd5fd"]]},{"id":"a674c122c98dd5fd","type":"http request","z":"d3adc843bdd47b30","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":430,"y":220,"wires":[["9b3afe892beae12c"]]},{"id":"9b3afe892beae12c","type":"function","z":"d3adc843bdd47b30","name":"Assemble message","func":"let message = msg.message || \"\";\nlet tinyurl = msg.payload || \"\";\n\nlet combined = message + \" \" + tinyurl;\n\nif (combined.length > 198) {\n    // Reserve space for two dots and the space before tinyurl\n    let maxMessageLength = 198 - (tinyurl.length + 1 + 2); // +1 for space, +2 for \"..\"\n\n    // Truncate message and add \"..\"\n    message = message.substring(0, maxMessageLength).trim() + \"..\";\n\n    combined = message + \" \" + tinyurl;\n}\n\nmsg.payload = combined;\nmsg.topic = \"REDTastic: SEVERE WEATHER WARNING\"\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":220,"wires":[["63e7ac5734a0fd01","120e3856efb68a6c"]]},{"id":"ba4631d9c6c15323","type":"inject","z":"d3adc843bdd47b30","name":"Test long msg","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"rss\":{\"channel\":[{\"item\":[{\"title\":[\"TEST MESSAGE Amber warning of heavy rain and flooding\"],\"description\":[\"TEST MESSAGE Amber warning of heavy rain and flooding affecting multiple counties including Herefordshire, Shropshire, Staffordshire, Worcestershire, and surrounding areas. Rain expected to be persistent and heavy from early morning through late evening, causing potential road closures, power outages, and disruption to public transport services.\"],\"guid\":[{\"_\":\"https://example.com/amber-heavy-rain\"}]}]}]}}","payloadType":"json","x":150,"y":240,"wires":[["caebc459f9ed3b37"]]},{"id":"120e3856efb68a6c","type":"link out","z":"d3adc843bdd47b30","name":"Severe weather out","mode":"link","links":["0bb32ddf524a90dc","18c893f109f93670","b24343ba7d6ac956"],"x":795,"y":220,"wires":[]},{"id":"1aa25991bd293036","type":"comment","z":"d3adc843bdd47b30","name":"Notes: Severe weather warnings","info":"This flow runs regularly via inject node \nauto triggering.\n\nThe first part of the flow here \npicks up severe weather info from the UK\nMet Office using one of the regional\nRSS feeds from the list below.\n\nThe flow will need to be modified if\nthe warning needs to come from a\ndifferent weather service or the Met Office \nchanges the format of their warninbgs.\n\nList of Met Office RSS feeds:\n\nhttps://weather.metoffice.gov.uk/guides/rss\n\nThis flow sends a Tx message when a warning is\navailable, and it can also send an email - enable \nthis link out if you wish. \n\nThe second part of this flow gets thunderstorm and\nhigh wind warnings from Open-Meteo.\n\nRemember to set your latitude and longitude on the \nfirst tab so that the weather is picked up for the\nright place. \n\nDisable the Async out node on the first tab while \ntesting any changes made here. Re-enable it when you\nare sure things are working as expected. \n\nRegional customisations may be available on the \nGitHub project page: \nhttps://github.com/linker3000/REDTastic","x":170,"y":40,"wires":[]},{"id":"678370c286858209","type":"http request","z":"d3adc843bdd47b30","name":"Met office http request","method":"GET","ret":"txt","paytoqs":"ignore","url":"https://weather.metoffice.gov.uk/public/data/PWSCache/WarningsRSS/Region/se","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":440,"y":100,"wires":[["6ffbc95fd64a73d8"]]},{"id":"32243c9a7662a85d","type":"inject","z":"d3adc843bdd47b30","name":"Test no warning","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"rss\":{\"channel\":[{\"title\":[\"Met Office warnings for region\"],\"description\":[\"Weather warnings of severe and extreme weather from the Met Office\"]}]}}","payloadType":"json","x":160,"y":160,"wires":[["caebc459f9ed3b37"]]},{"id":"bf5e7bd00d181d3a","type":"function","z":"d3adc843bdd47b30","name":"Format Open-Meteo call","func":"// Get coordinates from global context, fallback to centre of London\nlet lat = global.get('latitude') || 51.5074;\nlet lon = global.get('longitude') || -0.1278;\n\n// Get relevant weather info from call to Open-Meteo\nmsg.url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code,wind_speed_10m&timezone=Europe/London`;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":380,"wires":[["f2ea5086d98d8260"]]},{"id":"f2ea5086d98d8260","type":"http request","z":"d3adc843bdd47b30","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":610,"y":380,"wires":[["0dfb25934239ddc6"]]},{"id":"bd0be95901d5aa8a","type":"inject","z":"d3adc843bdd47b30","name":"Boring weather","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":120,"y":400,"wires":[["bf5e7bd00d181d3a"]]},{"id":"0dfb25934239ddc6","type":"function","z":"d3adc843bdd47b30","name":"Check for thunderstorms and high wind","func":"// Handle different response formats from HTTP request\nvar weatherData;\nif (typeof msg.payload === \"string\") {\n    try {\n        weatherData = JSON.parse(msg.payload);\n    } catch (e) {\n        node.error(\"Failed to parse JSON: \" + e.message);\n        return null;\n    }\n} else if (typeof msg.payload === \"object\") {\n    weatherData = msg.payload;\n} else {\n    node.error(\"Unexpected payload type: \" + typeof msg.payload);\n    return null;\n}\n\n// Check if we have the expected structure\nif (!weatherData || !weatherData.current) {\n    node.error(\"Invalid payload structure. Expected current weather data\");\n    return null;\n}\n\n// Extract weather data\nvar weatherCode = weatherData.current.weather_code;\nvar windSpeed = weatherData.current.wind_speed_10m;\nvar region = global.get('region') || 'your area';\n\nvar hasThunderstorms = weatherCode >= 95;\nvar hasStrongWinds = windSpeed > 50;\n\n// Check all combinations\nif (hasThunderstorms && hasStrongWinds) {\n    var windSpeedMph = Math.round(windSpeed * 0.621371 * 2) / 2;\n    msg.payload = \"Thunderstorms and strong winds forecast in the region around \" + region + \" (\" + windSpeedMph + \" mph). (Open-Meteo)\";\n    return msg;\n} else if (hasThunderstorms) {\n    msg.payload = \"Thunderstorms forecast in the region around \" + region + \". (Open-Meteo)\";\n    return msg;\n} else if (hasStrongWinds) {\n    var windSpeedMph = Math.round(windSpeed * 0.621371 * 2) / 2;\n    msg.payload = \"Strong winds forecast in the region around \" + region + \" (\" + windSpeedMph + \" mph). (Open-Meteo)\";\n    return msg;\n}\n\n// No severe weather detected\nreturn null;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":440,"wires":[["42d09ee8bc264a1a","52718e6c26c351ae"]]},{"id":"42d09ee8bc264a1a","type":"debug","z":"d3adc843bdd47b30","name":"Open-Meteo thunder/wind","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":650,"y":500,"wires":[]},{"id":"52718e6c26c351ae","type":"link out","z":"d3adc843bdd47b30","name":"Open-Meteo weather warning","mode":"link","links":["0bb32ddf524a90dc","18c893f109f93670","b24343ba7d6ac956"],"x":795,"y":440,"wires":[]},{"id":"7223d822ac384155","type":"inject","z":"d3adc843bdd47b30","name":"Test thunder","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"current\":{\"weather_code\":95,\"wind_speed_10m\":25}}","payloadType":"json","x":130,"y":440,"wires":[["0dfb25934239ddc6"]]},{"id":"1d5a8ef0799235f4","type":"inject","z":"d3adc843bdd47b30","name":"Test windspeed","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"current\":{\"weather_code\":2,\"wind_speed_10m\":65}}","payloadType":"json","x":140,"y":480,"wires":[["0dfb25934239ddc6"]]},{"id":"ab71f9d517846ca0","type":"inject","z":"d3adc843bdd47b30","name":"Test both","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"current\":{\"weather_code\":96,\"wind_speed_10m\":75}}","payloadType":"json","x":120,"y":520,"wires":[["0dfb25934239ddc6"]]},{"id":"d5bba44b625f68fc","type":"link in","z":"2f92a99e559c4ceb","name":"News in","links":["dd857ed9a24a14d1"],"x":125,"y":120,"wires":[["c8c215c3701e6bd4"]]},{"id":"4a9a804345cca0fb","type":"link out","z":"2f92a99e559c4ceb","name":"News out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":1065,"y":300,"wires":[]},{"id":"45700b5adfd8309d","type":"feedparser-simple","z":"2f92a99e559c4ceb","name":"Get RSS feed","x":760,"y":120,"wires":[["ec3144ab1be9d1d8"]]},{"id":"bbdab6b4bfda1db3","type":"trigger","z":"2f92a99e559c4ceb","name":"Set RSS feed url","op1":"","op2":"http://feeds.bbci.co.uk/news/rss.xml","op1type":"nul","op2type":"str","duration":"250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":410,"y":140,"wires":[["3821e71aedba23a4","45700b5adfd8309d"]]},{"id":"c2ac078c64021bc7","type":"debug","z":"2f92a99e559c4ceb","name":"News output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":990,"y":360,"wires":[]},{"id":"23a196f486a55592","type":"inject","z":"2f92a99e559c4ceb","name":"Test 5","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn,5","payloadType":"str","x":150,"y":300,"wires":[["c8c215c3701e6bd4"]]},{"id":"ec3144ab1be9d1d8","type":"function","z":"2f92a99e559c4ceb","name":"Limit articles used","func":"// Retrieve the processed count from flow context (initialize to 0 if not set)\nlet count = flow.get('processedCount') || 0; \n\nlet numItems = flow.get('numItems') || 5;\n\n// Process the message only if we haven't processed the required number of items yet\nif (count < numItems) {\n    count += 1;  // Increment the count for each processed item\n\n    let messageContent = msg.payload;\n\n    // Truncate the message if it's longer than 198 characters\n    if (messageContent.length > 198) {\n        messageContent = messageContent.slice(0, 198);  \n    }\n\n    msg.article = messageContent;\n\n    // Update the processed count in flow context so it persists across messages\n    flow.set('processedCount', count);\n\n    return msg;\n} else {\n    return null;  // Stop processing further messages for this batch\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":180,"wires":[["dd16621c9555b708"]]},{"id":"3361a2810daa4e88","type":"inject","z":"2f92a99e559c4ceb","name":"Test 99","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn,99","payloadType":"str","x":150,"y":340,"wires":[["c8c215c3701e6bd4"]]},{"id":"3821e71aedba23a4","type":"delay","z":"2f92a99e559c4ceb","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":730,"y":60,"wires":[["45700b5adfd8309d"]]},{"id":"663a229b951ba61b","type":"change","z":"2f92a99e559c4ceb","name":"Extract URL","rules":[{"t":"set","p":"payload","pt":"msg","to":"topic","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":240,"wires":[["dbcaedecd03f3753"]]},{"id":"93445ef0a2ab97bc","type":"http request","z":"2f92a99e559c4ceb","name":"Get TinyURL","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":670,"y":300,"wires":[["8d12d12e759494e6"]]},{"id":"dbcaedecd03f3753","type":"function","z":"2f92a99e559c4ceb","name":"Format request","func":"// Get the long URL from msg.payload\nlet longUrl = msg.payload;\n\n// Check if the long URL is valid\nif (!longUrl || typeof longUrl !== 'string') {\n    node.error(\"Invalid URL\", msg);\n    return null;  // Exit the function if the URL is invalid\n}\n\n// Check if the URL contains a '?'\nlet questionMarkIndex = longUrl.indexOf('?');\n\n// If it contains a '?', remove everything after it, including the '?' itself\nif (questionMarkIndex !== -1) {\n    longUrl = longUrl.substring(0, questionMarkIndex);  // Keep the part before '?'\n}\n\n// Prepare the URL for TinyURL\nlet tinyUrlApi = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`;\n\n// Set the HTTP request configuration\nmsg.url = tinyUrlApi;  // TinyURL API endpoint\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":240,"wires":[["93445ef0a2ab97bc"]]},{"id":"e8f8cd5bbbb8c90e","type":"inject","z":"2f92a99e559c4ceb","name":"Test 1 with URL","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn,1,u","payloadType":"str","x":120,"y":380,"wires":[["c8c215c3701e6bd4"]]},{"id":"b35ec2380126e7c5","type":"function","z":"2f92a99e559c4ceb","name":"Set \"append URL\" flag","func":"let inputString = msg.payload;\n\n// Check if the string contains \",u\" (case-insensitive)\nlet hasTinyUrl = inputString.toLowerCase().includes(',u');\n\nflow.set('tinyurlFlag', hasTinyUrl ? 1 : 0);\n\n// Just in case the message is wanted for other nodes...\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":200,"wires":[[]]},{"id":"8d12d12e759494e6","type":"function","z":"2f92a99e559c4ceb","name":"Assemble output","func":"// Retrieve the article text (msg.article) and TinyURL (msg.payload)\nlet articleText = '- ' + msg.article;\nlet tinyUrl = msg.payload;\n\nlet maxLength = 196;\n\n// Retrieve the flow context variable that indicates if we should append the TinyURL\nlet tinyurlFlag = flow.get('tinyurlFlag') || 0;  // Default to 0 if not set\n\n// If tinyurlFlag is 1, append the TinyURL to the article text\nif (tinyurlFlag === 1) {\n    // Calculate remaining space for the article text after appending the TinyURL and a space\n    let remainingSpace = maxLength - tinyUrl.length - 1;  // 1 for the space between TinyURL and article\n\n    if (remainingSpace < articleText.length) {\n        articleText = articleText.substring(0, remainingSpace);  // Truncate the article\n    }\n\n    // Combine the TinyURL and the article text\n    msg.payload = articleText + ' ' + tinyUrl + '\\n';\n} else {\n    // If tinyurlFlag is 0, just return the article text, truncated if necessary\n    msg.payload = articleText.substring(0, maxLength) + '\\n';\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":300,"wires":[["c2ac078c64021bc7","4a9a804345cca0fb"]]},{"id":"7b578d03351903d1","type":"inject","z":"2f92a99e559c4ceb","name":"Test no num","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn","payloadType":"str","x":130,"y":220,"wires":[["c8c215c3701e6bd4"]]},{"id":"39db790f570bd2cc","type":"inject","z":"2f92a99e559c4ceb","name":"Test 1","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn,1","payloadType":"str","x":150,"y":260,"wires":[["c8c215c3701e6bd4"]]},{"id":"76bd19d8ca5dd88a","type":"function","z":"2f92a99e559c4ceb","name":"Set number of articles","func":"// Parse input to set numItems\nlet inputString = msg.payload.trim();\nlet numItems = 5;  // Default numItems value\n\n// Check if the string contains a comma followed by a number anywhere in the string\nlet regex = /,(\\d+)/;\nlet match = inputString.match(regex);\n\nif (match) {\n    numItems = parseInt(match[1]);\n    numItems = Math.min(numItems, 10);  // Limit numItems to 10\n}\n\nflow.set('numItems', numItems);\n\n// Reset the processed count to 0 (start fresh for the new batch)\nflow.set('processedCount', 0);\n\n// Reset the 'alreadyProcessed' flag so that it doesn't block future messages\nflow.set('alreadyProcessed', false);\n\n// Store numItems in msg for later use\nmsg.numItems = numItems;\nmsg.payload = numItems;\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":240,"wires":[[]]},{"id":"c5f2c0ca918a1de6","type":"inject","z":"2f92a99e559c4ceb","name":"Test 5 with URL","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"/l3kn,5,u","payloadType":"str","x":120,"y":420,"wires":[["c8c215c3701e6bd4"]]},{"id":"dd16621c9555b708","type":"delay","z":"2f92a99e559c4ceb","name":"Rate limit","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":860,"y":180,"wires":[["663a229b951ba61b"]]},{"id":"79a38265e3825515","type":"comment","z":"2f92a99e559c4ceb","name":"News notes","info":"The default setup picks up the news headlines \nand descriptions from the BBC RSS service.\n\nThis flow may need to be modified if you \nwant to pick up the news from other\nsources. If applicable, other news\nflows will be made available on the\nproject's GitHub page:\n\nhttps://github.com/linker3000/REDTastic\n\nIf you develop a new flow please share.","x":150,"y":40,"wires":[]},{"id":"f09a1a190d73baaf","type":"link in","z":"2f92a99e559c4ceb","name":"Reset rate limits","links":["b9f3d38e3d1fc041"],"x":565,"y":60,"wires":[["3821e71aedba23a4"]]},{"id":"request-zenquote","type":"http request","z":"85744c86c3981ac5","name":"Get Zen Quote","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://zenquotes.io/api/random","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":280,"y":120,"wires":[["format-zenquote"]]},{"id":"format-zenquote","type":"function","z":"85744c86c3981ac5","name":"Format Zen Quote","func":"let quote = msg.payload[0].q;  // The quote text\nlet author = msg.payload[0].a; // The author\n\nif (quote.trim().length === 0) {\n        return null;\n    }\n    \nmsg.payload = quote;\nif (msg.payload.length > 198) {\n        msg.payload = msg.payload.substring(0, 198); \n}   \nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":120,"wires":[["a6e1ebdc2cf67ea4","55923a933cb83282"]]},{"id":"87446c31d5382738","type":"inject","z":"85744c86c3981ac5","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":150,"y":180,"wires":[["request-zenquote"]]},{"id":"94ed5dec96f4d051","type":"link out","z":"85744c86c3981ac5","name":"MOTD out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":845,"y":120,"wires":[]},{"id":"dec68dbab3675569","type":"link in","z":"85744c86c3981ac5","name":"MOTD in","links":["648b121e3ad619e4"],"x":95,"y":120,"wires":[["request-zenquote"]]},{"id":"a6e1ebdc2cf67ea4","type":"delay","z":"85744c86c3981ac5","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":710,"y":120,"wires":[["94ed5dec96f4d051"]]},{"id":"55923a933cb83282","type":"debug","z":"85744c86c3981ac5","name":"Zen quote","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":180,"wires":[]},{"id":"eca053148a224921","type":"link in","z":"85744c86c3981ac5","name":"Reset rate limits","links":["b9f3d38e3d1fc041"],"x":585,"y":60,"wires":[["a6e1ebdc2cf67ea4"]]},{"id":"b561b5dcbaec1970","type":"link in","z":"85744c86c3981ac5","name":"Info msg in","links":["2209f52df597f83d"],"x":135,"y":300,"wires":[["cbf03d672c772638"]]},{"id":"cbf03d672c772638","type":"function","z":"85744c86c3981ac5","name":"Format info message","func":"if (global.get('info')) {\n    msg.payload = global.get('info');\n    return msg;\n} else {\n    return null; // Don't send anything if either value is missing or empty\n}\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":300,"wires":[["ba0a013f0fe9a567","48a17ceae0dbae76"]]},{"id":"ba0a013f0fe9a567","type":"delay","z":"85744c86c3981ac5","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":710,"y":300,"wires":[["7dc3f411794e0b2c"]]},{"id":"82fa93b2c0d63529","type":"link in","z":"85744c86c3981ac5","name":"Reset rate limits","links":["b9f3d38e3d1fc041"],"x":595,"y":260,"wires":[["ba0a013f0fe9a567"]]},{"id":"7dc3f411794e0b2c","type":"link out","z":"85744c86c3981ac5","name":"Info msg out","mode":"link","links":["0bb32ddf524a90dc","b24343ba7d6ac956"],"x":845,"y":300,"wires":[]},{"id":"05a8e4fb3a1cfd79","type":"inject","z":"85744c86c3981ac5","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":150,"y":360,"wires":[["cbf03d672c772638"]]},{"id":"48a17ceae0dbae76","type":"debug","z":"85744c86c3981ac5","name":"Info message","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":360,"wires":[]},{"id":"d06eb20ee021cddd","type":"ui-text-input","z":"03120120b21c40b4","group":"50c1d0e584ea6dda","name":"Message field","label":"Message","order":1,"width":0,"height":0,"topic":"topic","topicType":"msg","mode":"text","tooltip":"","delay":300,"passthru":false,"sendOnDelay":false,"sendOnBlur":false,"sendOnEnter":true,"className":"","clearable":true,"sendOnClear":true,"icon":"","iconPosition":"left","iconInnerPosition":"inside","x":760,"y":80,"wires":[["b8142610e643f56f","958a6906fd75b37d"]]},{"id":"b8142610e643f56f","type":"function","z":"03120120b21c40b4","name":"Sanitize message","func":"if (typeof msg.payload === 'string') {\n    // Remove non-ASCII characters\n    msg.payload = msg.payload.replace(/[^\\x00-\\x7F]/g, '');\n    // Limit length to 198 characters\n    msg.payload = msg.payload.slice(0, 198);\n    // Trim whitespace and drop if empty\n    if (msg.payload.trim() === '') {\n        return null; // message is empty, do not send\n    }\n}\n\n// Get the current local time in 24-hour format\nlet currentTime = new Date().toLocaleTimeString(global.get('locale') || 'en-GB', { hour12: false });\n\n// Format the timestamp as DD-MMM HH:MM\nlet now = new Date();\nlet day = String(now.getDate()).padStart(2, '0');\nlet monthNames = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\",\n    \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\nlet month = monthNames[now.getMonth()];\n\n// Extract HH:MM from currentTime (HH:MM:SS)\nlet hhmm = currentTime.split(':').slice(0, 2).join(':');\n\n// Create second message with timestamp\nlet msgWithTimestamp = { ...msg };\nmsgWithTimestamp.payload = `${day}-${month} ${hhmm} ${msg.payload}`;\n\n// Return both outputs: first is original, second is with timestamp\nreturn [msg, msgWithTimestamp];\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":160,"wires":[["042001175ba86aa1"],["e47274b01dbfe467"]]},{"id":"b30d87047c75a012","type":"link out","z":"03120120b21c40b4","name":"Message out","mode":"link","links":["0bb32ddf524a90dc"],"x":875,"y":160,"wires":[]},{"id":"958a6906fd75b37d","type":"trigger","z":"03120120b21c40b4","name":"Clear text field","op1":"","op2":"","op1type":"str","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":360,"y":80,"wires":[["6ceb7c2d46a895e1"]]},{"id":"f30b4a22c3ca92d3","type":"link in","z":"03120120b21c40b4","name":"Dashboard in","links":["08177ad9b6ad71ed"],"x":225,"y":340,"wires":[["01c89031dfa46b02"]]},{"id":"6ceb7c2d46a895e1","type":"change","z":"03120120b21c40b4","name":"Set empty string","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":80,"wires":[["d06eb20ee021cddd"]]},{"id":"012faea2d902d7c8","type":"inject","z":"03120120b21c40b4","name":"Clear field","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":150,"y":80,"wires":[["958a6906fd75b37d"]]},{"id":"042001175ba86aa1","type":"delay","z":"03120120b21c40b4","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":740,"y":160,"wires":[["b30d87047c75a012"]]},{"id":"91472f77b6b70e49","type":"function","z":"03120120b21c40b4","name":"Random test data","func":"function generateRandomString() {\n    const months = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\n    \n    // Random day (01-31)\n    const day = String(Math.floor(Math.random() * 31) + 1).padStart(2, '0');\n    \n    // Random month\n    const month = months[Math.floor(Math.random() * months.length)];\n    \n    // Random year (1900-2099)\n    const year = Math.floor(Math.random() * 200) + 1900;\n    \n    // Current local time in 24-hour format\n    let currentTime = new Date().toLocaleTimeString(global.get('locale') || 'en-GB', { hour12: false });\n    // Extract HH:MM\n    let hhmm = currentTime.split(':').slice(0, 2).join(':');\n    \n    // Random length between 90 and 190\n    const randomLength = Math.floor(Math.random() * (190 - 90 + 1)) + 90;\n    \n    // Generate random string of randomLength\n    let randomText = '';\n    while (randomText.length < randomLength) {\n        randomText += Math.random().toString(36).substring(2);\n    }\n    randomText = randomText.substring(0, randomLength); // trim to exact length\n    \n    // Format: literal 'AAAA ' + date + HH:MM + ': ' + random text\n    return `AAAA ${day}-${month}-${year} ${hhmm}: ${randomText}`;\n}\n\nmsg.payload = generateRandomString();\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":400,"wires":[["e47274b01dbfe467"]]},{"id":"c5f6bbd676e919c3","type":"inject","z":"03120120b21c40b4","name":"Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":210,"y":400,"wires":[["91472f77b6b70e49"]]},{"id":"scroll-log-simple","type":"ui-template","z":"03120120b21c40b4","group":"50c1d0e584ea6dda","page":"","ui":"","name":"Scrolling message area","order":2,"width":6,"height":8,"format":"<div ref=\"logContainer\"\n     style=\"height:415px;\n            overflow-y:auto;\n            background:#f5f5f5;\n            padding:8px;\n            border:1px solid #ccc;\n            font-family:monospace;\n            white-space:pre-wrap;\">\n  <div v-for=\"(line,index) in msg.payload\"\n       :key=\"index\"\n       style=\"display:block;\">\n    {{ line }}\n  </div>\n</div>\n\n<script>\n(function(scope){\n    scope.$watch('msg.payload', function(){\n        scope.$nextTick(function(){\n            const el = scope.$refs.logContainer;\n            if (el) el.scrollTop = el.scrollHeight;\n        });\n    });\n})(scope);\n</script>\n","storeOutMessages":false,"passthru":true,"resendOnRefresh":true,"templateScope":"local","className":"","x":750,"y":340,"wires":[[]]},{"id":"e47274b01dbfe467","type":"function","z":"03120120b21c40b4","name":"Line buffer","func":"// Accumulate log lines in node context\nlet log = context.get('log') || [];\n\n// Check for reset\nif (msg.reset === true) {\n    log = [];  // clear the log\n} else if (msg.payload !== undefined) {\n    let line = msg.payload;\n    log.push(line);\n\n    // keep last 20 lines (optional)\n    if (log.length > 20) log.shift();\n}\n\n// store updated log in context\ncontext.set('log', log);\n\n// send the entire array to the template\nreturn { payload: log };\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":280,"wires":[["scroll-log-simple"]]},{"id":"53ba012975718d04","type":"inject","z":"03120120b21c40b4","name":"Reset buffer","props":[{"p":"reset","v":"true","vt":"bool"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":170,"y":220,"wires":[["2930da81f3323cf7"]]},{"id":"2930da81f3323cf7","type":"ui-button","z":"03120120b21c40b4","group":"50c1d0e584ea6dda","name":"Clear messages","label":"Clear messages","order":3,"width":0,"height":0,"emulateClick":true,"tooltip":"","color":"","bgcolor":"","className":"","icon":"","iconPosition":"left","payload":"true","payloadType":"bool","topic":"reset","topicType":"msg","buttonColor":"","textColor":"","iconColor":"","enableClick":true,"enablePointerdown":false,"pointerdownPayload":"","pointerdownPayloadType":"str","enablePointerup":false,"pointerupPayload":"","pointerupPayloadType":"str","x":220,"y":280,"wires":[["4c781828fa9bf1bd"]]},{"id":"4c781828fa9bf1bd","type":"change","z":"03120120b21c40b4","name":"Reset signal","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":280,"wires":[["e47274b01dbfe467"]]},{"id":"01c89031dfa46b02","type":"function","z":"03120120b21c40b4","name":"Format received msg","func":"// Get the current local time in 24-hour format\nlet currentTime = new Date().toLocaleTimeString(global.get('locale') || 'en-GB', { hour12: false });\n// Extract HH:MM\nlet hhmm = currentTime.split(':').slice(0, 2).join(':');\n\n// Get today's date\nconst now = new Date();\nconst day = String(now.getDate()).padStart(2, '0');\nconst monthNames = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\",\n                    \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\nconst month = monthNames[now.getMonth()];\nconst year = now.getFullYear();\n\n// Split input at the first colon\nlet inboundID = \"\";\nlet messageText = \"\";\nif (typeof msg.payload === \"string\") {\n    const index = msg.payload.indexOf(':');\n    if (index !== -1) {\n        inboundID = msg.payload.substring(0, index).trim();   // ID before colon\n        messageText = msg.payload.substring(index + 1).trim(); // Text after colon\n    } else {\n        inboundID = \"ID\";             // fallback if no colon\n        messageText = msg.payload;\n    }\n}\n\n// Construct final message\nmsg.payload = `${inboundID} ${day}-${month}-${year} ${hhmm}: ${messageText}`;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":340,"wires":[["e47274b01dbfe467"]]},{"id":"33eb8609dccf8332","type":"comment","z":"03120120b21c40b4","name":"Dashboard notes","info":"The dashbaord shows received messages and also has a\nfield to send messages.\n\nIf the outbound message is longer than 198 characters,\nit will be split between separate messages. \n","x":140,"y":40,"wires":[]},{"id":"cb86dacbb2573071","type":"global-config","env":[],"modules":{"node-red-node-serialport":"2.0.3","@flowfuse/node-red-dashboard":"1.28.0","node-red-node-email":"3.1.0","node-red-contrib-astrodata":"0.0.4","node-red-contrib-feedparser-simple":"0.0.2"}}]